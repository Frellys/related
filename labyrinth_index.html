<!DOCTYPE html>
<html>
<head>
    <title>labyrinth_index</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        :root {
            --color-active: rgba(245, 245, 245, 0.9);
            --color-hover: rgba(245, 245, 245, 0.75);
            --color-main: rgba(245, 245, 245, 0.6);
        }

        html {
            user-select: none;
            overflow: hidden;
        }

        body {
            margin: 0;
            padding: 0;
            background-color: #323232;
            display: table-cell;
            height: 100vh;
            width: 100vw;
            vertical-align: middle;
            font-family: monospace;
        }

        main {
            width: fit-content;
            height: auto;
            margin: 0 auto;
        }

            main > header {
                display: flex;
                flex-direction: row;
            }

                main > header > div {
                    width: 10ch;
                    text-align: center;
                    padding: 0.5ch 0;
                    font-size: 1.5rem;
                    cursor: pointer;
                }

                    main > header > div.sel {
                        color: var(--color-active);
                        border-bottom: 0.25rem solid var(--color-active);
                    }

                    main > header > div:not(.sel) {
                        color: var(--color-main);
                        border-bottom: 0.25rem solid transparent;
                    }

                        main > header > div:not(.sel):hover {
                            color: var(--color-hover);
                        }

            main > section {
                min-height: 30ch;
                padding: 1ch;
            }

                main > section.sel {
                    display: flex;
                    flex-direction: column;
                }

                main > section:not(.sel) {
                    display: none;
                }

                main > section:nth-of-type(1) {
                    justify-content: space-evenly;
                }

                    main > section:nth-of-type(1) > .wrap-slider {
                        display: flex;
                        flex-direction: column;
                        font-size: 1.1rem;
                        color: var(--color-active);
                    }

                        main > section:nth-of-type(1) > .wrap-slider > input {
                            -webkit-appearance: none;
                            width: 100%;
                            height: 1.5ch;
                            border-radius: 1.5ch;
                        }

                            main > section:nth-of-type(1) > .wrap-slider > input#width,
                            main > section:nth-of-type(1) > .wrap-slider > input#height {
                                outline: none;
                                margin-top: 0.5rem;
                            }

                            main > section:nth-of-type(1) > .wrap-slider > input::-webkit-slider-thumb {
                                -webkit-appearance: none;
                                width: 2.5ch;
                                height: 2.5ch;
                                background: whitesmoke;
                                box-shadow: 0 0 0.5ch #323232;
                                border-radius: 50%;
                            }

                    main > section:nth-of-type(1) > .wrap-run > #run {
                        width: fit-content;
                        padding: 0.5ch 2ch;
                        font-size: 1.25rem;
                        color: var(--color-active);
                        border: 0.25ch solid var(--color-active);
                        border-radius: 1ch;
                        cursor: pointer;
                    }

                        main > section:nth-of-type(1) > .wrap-run > #run:hover {
                            background-color: var(--color-active);
                            color: #323232;
                        }

                main > section:nth-of-type(2) {
                    justify-content: space-evenly;
                }

                    main > section:nth-of-type(2) > .wrap-slider {
                        display: flex;
                        flex-direction: column;
                        font-size: 1.1rem;
                        color: var(--color-active);
                    }

                        main > section:nth-of-type(2) > .wrap-slider > input {
                            -webkit-appearance: none;
                            width: 100%;
                            height: 1.5ch;
                            border-radius: 1.5ch;
                        }

                            main > section:nth-of-type(2) > .wrap-slider > input#bgm,
                            main > section:nth-of-type(2) > .wrap-slider > input#sfx {
                                outline: none;
                                margin-top: 0.5rem;
                            }

                            main > section:nth-of-type(2) > .wrap-slider > input::-webkit-slider-thumb {
                                -webkit-appearance: none;
                                width: 2.5ch;
                                height: 2.5ch;
                                background: whitesmoke;
                                box-shadow: 0 0 0.5ch #323232;
                                border-radius: 50%;
                            }

                main > section:nth-of-type(3) {
                    align-items: center;
                    justify-content: center;
                    color: var(--color-main);
                }

                    main > section:nth-of-type(3) > label {
                        font-size: 2.5rem;
                        margin-bottom: 0.25ch;
                    }

                    main > section:nth-of-type(3) > .wrap {
                        display: flex;
                        flex-direction: row;
                        align-items: center;
                    }

                        main > section:nth-of-type(3) > .wrap > div {
                            width: fit-content;
                            padding: 0.5ch 2ch;
                            font-size: 1.25rem;
                            color: var(--color-main);
                            border: 0.25ch solid var(--color-main);
                            border-radius: 1ch;
                            cursor: pointer;
                        }

                            main > section:nth-of-type(3) > .wrap > div:hover {
                                color: #323232;
                                background-color: var(--color-active);
                                border: 0.25ch solid var(--color-active);
                            }

        #esc {
            position: absolute;
            top: 0;
            left: 0;
            padding: 1ch 2ch;
            font-size: 2rem;
            color: var(--color-main);
            cursor: pointer;
        }

            #esc:hover {
                color: var(--color-hover);
            }

        svg {
            display: block;
            margin: 0 auto;
            shape-rendering: optimizeSpeed;
            width: 100vw;
            height: 100vh;
            pointer-events: none;
        }
    </style>
</head>
<body>
    <main>
        <header>
            <div data-section="0" class="sel">PLAY</div>
            <div data-section="1">OPTIONS</div>
            <div data-section="2">EXIT</div>
        </header>
        <section class="sel">
            <div class="wrap-slider">
                <div>width:&nbsp;<label for="width">50</label></div>
                <input type="range" id="width" name="width" min="10" max="99" value="50" step="1">
            </div>
            <div class="wrap-slider">
                <div>height:&nbsp;<label for="height">50</label></div>
                <input type="range" id="height" name="height" min="10" max="99" value="50" step="1">
            </div>
            <div class="wrap-run">
                <div id="run">START</div>
            </div>
        </section>
        <section>
            <div class="wrap-slider">
                <div>BGM:&nbsp;<label for="bgm">50</label></div>
                <input type="range" id="bgm" name="bgm" min="0" max="100" value="50" step="1">
            </div>
            <div class="wrap-slider">
                <div>SFX:&nbsp;<label for="sfx">50</label></div>
                <input type="range" id="sfx" name="sfx" min="0" max="100" value="50" step="1">
            </div>
        </section>
        <section>
            <label>SURE?</label>
            <div class="wrap">
                <div id="y">yes</div>
                <span>&nbsp;/&nbsp;</span>
                <div id="n">no</div>
            </div>
        </section>
    </main>
    <svg></svg>
    <div id="esc">esc</div>
    <script>
        let level = {};
        let player = {
            node: false,
            isMoving: false,
            isFinish: false,
            CheckPos: function () {
                if (this.pos.x == fin.x && this.pos.y == fin.y) {
                    this.isFinish = true;
                }
            },
            pos: {
                x: 0,
                y: 0
            },
            dpos: {
                x: 0,
                y: 0
            }
        };
        let borders = {
            ArrowUp: 't',
            ArrowRight: 'r',
            ArrowDown: 'b',
            ArrowLeft: 'l'
        };
        let arrows = {
            ArrowUp: function () { player.pos.y--; },
            ArrowRight: function () { player.pos.x++; },
            ArrowDown: function () { player.pos.y++; },
            ArrowLeft: function () { player.pos.x--; }
        };
        let curPressed = false;
        window.addEventListener('keydown', function (e) {
            console.log(!player.isMoving);
            console.log(app.scene === 'level');
            console.log(e.code in arrows);
            console.log(!curPressed);
            if (!player.isFinish && !player.isMoving && app.scene === 'level' && (e.code in arrows) && !curPressed) {
                curPressed = player.isMoving = e.code;
                if (field[player.pos.y][player.pos.x].links.includes(borders[e.code])) {
                    arrows[e.code]();
                }
            }
        }, false);
        window.addEventListener('keyup', function (e) {
            if (curPressed === e.code) {
                curPressed = false;
            }
        }, false);
        let app = {
            scene: 'main'
        };
        let setDisplay = function (scene) {
            app.scene = scene;
            document.body.querySelector('main').style.display = (app.scene == 'main') ? 'block' : 'none';
            document.body.querySelector('#esc').style.display = (app.scene == 'main') ? 'none' : 'block';
            document.body.querySelector('svg').style.display = (app.scene == 'main') ? 'none' : 'block';
        };
        let selectors = document.body.querySelectorAll('main > header > div');
        let sections = document.body.querySelectorAll('main > section');
        selectors.forEach(function (sel) {
            sel.addEventListener('click', function () {
                selectors.forEach(el => el.classList.remove('sel'));
                sections.forEach(el => el.classList.remove('sel'));
                this.classList.add('sel');
                sections[this.dataset.section].classList.add('sel');
            }, false);
        });
        let params = {
            width: { min: 10, max: 99, value: 50 },
            height: { min: 10, max: 99, value: 50 }
        };
        ['width', 'height'].forEach(function (el) {
            document.body.querySelector(`main > section:nth-of-type(1) > .wrap-slider > div > label[for="${el}"]`).innerHTML = params[el].value;
            document.documentElement.style.setProperty(`--value-${el}`, (params[el].max + params[el].min) / 100 * params[el].value - params[el].min + '%');
        });
        document.body.querySelectorAll('main > section:nth-of-type(1) > .wrap-slider > input').forEach(function (input) {
            input.addEventListener('input', function () {
                document.body.querySelector(`main > section:nth-of-type(1) > .wrap-slider > div > label[for="${this.id}"]`).innerHTML = this.value;
                document.documentElement.style.setProperty(`--value-${this.id}`, (params[this.id].max + params[this.id].min) / 100 * this.value - params[this.id].min + '%');
            }, false);
        });
        document.body.querySelector('main > section:nth-of-type(1) > .wrap-run > #run').addEventListener('click', function () {
            drawLabyrinth(generateLabyrinth());
        }, false);
        //let options = {
        //    bgm: { min: 0, max: 100, value: 50 },
        //    sfx: { min: 0, max: 100, value: 50 }
        //};
        //['bgm', 'sfx'].forEach(function (el) {
        //    document.body.querySelector(`main > section:nth-of-type(2) > .wrap-slider > div > label[for="${el}"]`).innerHTML = options[el].value;
        //    document.documentElement.style.setProperty(`--value-${el}`, (options[el].max + options[el].min) / 100 * options[el].value - options[el].min + '%');
        //});
        //document.querySelectorAll('main > section:nth-of-type(2) > .wrap-slider > input').forEach(function (input) {
        //    input.addEventListener('input', function () {
        //        document.body.querySelector(`main > section:nth-of-type(2) > .wrap-slider > div > label[for="${this.id}"]`).innerHTML = this.value;
        //        document.documentElement.style.setProperty(`--value-${this.id}`, (options[this.id].max + options[this.id].min) / 100 * this.value - options[this.id].min + '%');
        //    }, false);
        //});
        setDisplay('main');
        document.body.querySelector('#esc').addEventListener('click', function () {
            setDisplay('main');
        }, false);
        window.addEventListener('keyup', function (e) {
            if (e.code === 'Escape' && app.scene == 'level') {
                setDisplay('main');
            }
        }, false);
        /**
         * genereates labyrynth
         */
        let field;
        let path;
        let fin;
        let generateLabyrinth = function () {
            let width = parseInt(document.body.querySelector('main > section:nth-of-type(1) > .wrap-slider > #width').value);
            let height = parseInt(document.body.querySelector('main > section:nth-of-type(1) > .wrap-slider > #height').value);
            path = [];
            let curPath = [];
            let pos = {
                x: Math.floor(Math.random() * width),
                y: Math.floor(Math.random() * height)
            };
            let start = {
                x: pos.x,
                y: pos.y
            };
            field = Array.from(new Array(height).fill(), () => new Array(width).fill(true));
            field[pos.y][pos.x] = {
                links: [],
                tlcp: {
                    x: 0,
                    y: 0
                }
            };
            while (field.some(row => row.some(el => el === true))) {
                let routes = {
                    t: (pos.y > 0 && field[pos.y - 1][pos.x] === true),
                    r: (pos.x < width - 1 && field[pos.y][pos.x + 1] === true),
                    b: (pos.y < height - 1 && field[pos.y + 1][pos.x] === true),
                    l: (pos.x > 0 && field[pos.y][pos.x - 1] === true)
                };
                if (path.length < curPath.push({ x: pos.x, y: pos.y })) {
                    path = JSON.parse(JSON.stringify(curPath));
                }
                let cap = Object.keys(routes).filter(key => routes[key]).length;
                if (cap) {
                    let val = +(window.crypto.getRandomValues(new Uint32Array(1))[0].toString()[0]) % cap;
                    let dir = Object.keys(routes).filter(key => routes[key])[val];
                    field[pos.y][pos.x].links.push(dir);
                    switch (dir) {
                        case 't': { pos.y -= 1; field[pos.y][pos.x] = { links: ['b'], tlcp: { x: 0, y: 0 } }; break; }
                        case 'r': { pos.x += 1; field[pos.y][pos.x] = { links: ['l'], tlcp: { x: 0, y: 0 } }; break; }
                        case 'b': { pos.y += 1; field[pos.y][pos.x] = { links: ['t'], tlcp: { x: 0, y: 0 } }; break; }
                        case 'l': { pos.x -= 1; field[pos.y][pos.x] = { links: ['r'], tlcp: { x: 0, y: 0 } }; break; }
                    };
                }
                else {
                    curPath.pop();
                    pos = curPath.pop();
                }
            }
            fin = {
                x: path[path.length - 1].x,
                y: path[path.length - 1].y
            };
            return { start };
        };
        /**
         * draws labyrinth
         */
        let tl;
        let tsize;
        let border;
        let drawLabyrinth = function ({ start }) {
            let rows = field.length;
            let cols = field[0].length;
            setDisplay('level');
            let vmin = Math.floor(Math.min(screen.width, screen.height) / 100);
            let width = 95 * vmin;
            let height = 95 * vmin;
            tsize = Math.max(width, height) / Math.max(cols, rows);
            tl = {
                x: screen.width / 2 - tsize * cols / 2,
                y: screen.height / 2 - tsize * rows / 2
            };
            let xmlns = 'http://www.w3.org/2000/svg';
            let svg = document.body.querySelector('svg');
            document.body.querySelectorAll('svg *').forEach(function (n) { n.remove(); });
            svg.setAttribute('viewbox', `0 0 ${screen.width} ${screen.height}`);
            border = {
                stroke: '#323232',
                strokeWidth: Math.ceil(tsize / 100 * 10),
                linecap: 'square'
            };
            field.forEach(function (row, rdx) {
                row.forEach(function (col, cdx) {
                    let tx = tsize * cdx;
                    let ty = tsize * rdx;
                    col.tlcp.x = tl.x + tx + border.strokeWidth;
                    col.tlcp.y = tl.y + ty + border.strokeWidth;
                    // bg
                    let rect = document.createElementNS(xmlns, 'rect');
                    rect.setAttribute('fill', 'rgba(245, 245, 245, 0.1)');
                    rect.setAttribute('stroke', 'transparent');
                    rect.setAttribute('x', tl.x + tx);
                    rect.setAttribute('y', tl.y + ty);
                    rect.setAttribute('width', tsize);
                    rect.setAttribute('height', tsize);
                    svg.appendChild(rect);
                    // end
                    if (cdx === fin.x && rdx === fin.y) {
                        let ftile = document.createElementNS(xmlns, 'rect');
                        ftile.setAttribute('fill', 'rgba(245, 222, 179, 0.15)');
                        ftile.setAttribute('stroke', 'transparent');
                        ftile.setAttribute('x', col.tlcp.x);
                        ftile.setAttribute('y', col.tlcp.y);
                        ftile.setAttribute('width', tsize - border.strokeWidth * 2);
                        ftile.setAttribute('height', tsize - border.strokeWidth * 2);
                        svg.appendChild(ftile);
                    }
                    // corners
                    let tlc = document.createElementNS(xmlns, 'rect');
                    tlc.setAttribute('fill', border.stroke);
                    tlc.setAttribute('x', tl.x + tx);
                    tlc.setAttribute('y', tl.y + ty);
                    tlc.setAttribute('width', border.strokeWidth);
                    tlc.setAttribute('height', border.strokeWidth);
                    svg.appendChild(tlc);
                    let trc = document.createElementNS(xmlns, 'rect');
                    trc.setAttribute('fill', border.stroke);
                    trc.setAttribute('x', tl.x + tx + tsize - border.strokeWidth);
                    trc.setAttribute('y', tl.y + ty);
                    trc.setAttribute('width', border.strokeWidth);
                    trc.setAttribute('height', border.strokeWidth);
                    svg.appendChild(trc);
                    let brc = document.createElementNS(xmlns, 'rect');
                    brc.setAttribute('fill', border.stroke);
                    brc.setAttribute('x', tl.x + tx + tsize - border.strokeWidth);
                    brc.setAttribute('y', tl.y + ty + tsize - border.strokeWidth);
                    brc.setAttribute('width', border.strokeWidth);
                    brc.setAttribute('height', border.strokeWidth);
                    svg.appendChild(brc);
                    let blc = document.createElementNS(xmlns, 'rect');
                    blc.setAttribute('fill', border.stroke);
                    blc.setAttribute('x', tl.x + tx);
                    blc.setAttribute('y', tl.y + ty + tsize - border.strokeWidth);
                    blc.setAttribute('width', border.strokeWidth);
                    blc.setAttribute('height', border.strokeWidth);
                    svg.appendChild(blc);
                    // borders
                    if (col.links.includes('t') === false) {
                        let b = document.createElementNS(xmlns, 'rect');
                        b.setAttribute('fill', border.stroke);
                        b.setAttribute('x', tl.x + tx + border.strokeWidth);
                        b.setAttribute('y', tl.y + ty);
                        b.setAttribute('width', tsize - border.strokeWidth * 2);
                        b.setAttribute('height', border.strokeWidth);
                        svg.appendChild(b);
                    }
                    if (col.links.includes('r') === false) {
                        let b = document.createElementNS(xmlns, 'rect');
                        b.setAttribute('fill', border.stroke);
                        b.setAttribute('x', tl.x + tx + tsize - border.strokeWidth);
                        b.setAttribute('y', tl.y + ty + border.strokeWidth);
                        b.setAttribute('width', border.strokeWidth);
                        b.setAttribute('height', tsize - border.strokeWidth * 2);
                        svg.appendChild(b);
                    }
                    if (col.links.includes('b') === false) {
                        let b = document.createElementNS(xmlns, 'rect');
                        b.setAttribute('fill', border.stroke);
                        b.setAttribute('x', tl.x + tx + border.strokeWidth);
                        b.setAttribute('y', tl.y + ty + tsize - border.strokeWidth);
                        b.setAttribute('width', tsize - border.strokeWidth * 2);
                        b.setAttribute('height', border.strokeWidth);
                        svg.appendChild(b);
                    }
                    if (col.links.includes('l') === false) {
                        let b = document.createElementNS(xmlns, 'rect');
                        b.setAttribute('fill', border.stroke);
                        b.setAttribute('x', tl.x + tx);
                        b.setAttribute('y', tl.y + ty + border.strokeWidth);
                        b.setAttribute('width', border.strokeWidth);
                        b.setAttribute('height', tsize - border.strokeWidth * 2);
                        svg.appendChild(b);
                    }
                });
            });
            // player
            player.pos.x = start.x;
            player.pos.y = start.y;
            player.dpos.x = tl.x + player.pos.x * tsize + border.strokeWidth;
            player.dpos.y = tl.y + player.pos.y * tsize + border.strokeWidth;
            player.isFinish = false;
            player.node = document.createElementNS(xmlns, 'rect');
            player.node.setAttribute('fill', 'wheat');
            player.node.setAttribute('x', player.dpos.x);
            player.node.setAttribute('y', player.dpos.y);
            player.node.setAttribute('width', tsize - border.strokeWidth * 2);
            player.node.setAttribute('height', tsize - border.strokeWidth * 2);
            svg.appendChild(player.node);
            // track
            let track = document.createElementNS(xmlns, 'polyline');
            track.setAttribute('points', path.map(p => {
                return [tl.x + p.x * tsize + tsize / 2, tl.y + p.y * tsize + tsize / 2].join(',');
            }).join(' '));
            track.setAttribute('fill', 'none');
            track.setAttribute('stroke', 'rgba(245, 245, 245, 0.1)');
            track.setAttribute('stroke-width', border.strokeWidth);
            svg.appendChild(track);
        };
        let pts;
        let step = 0.25 * 1000;
        window.requestAnimationFrame(function render(ts) {
            if (app.scene === 'level' && player.isMoving) {
                let delta = ts - pts;
                let shift = tsize * delta / step;
                switch (player.isMoving) {
                    case 'ArrowUp': {
                        player.dpos.y -= shift;
                        if (player.dpos.y <= field[player.pos.y][player.pos.x].tlcp.y) {
                            player.dpos.y = field[player.pos.y][player.pos.x].tlcp.y;
                            player.isMoving = false;
                            player.CheckPos();
                        }
                        player.node.setAttribute('y', player.dpos.y);
                        break;
                    }
                    case 'ArrowRight': {
                        player.dpos.x += shift;
                        if (player.dpos.x >= field[player.pos.y][player.pos.x].tlcp.x) {
                            player.dpos.x = field[player.pos.y][player.pos.x].tlcp.x;
                            player.isMoving = false;
                            player.CheckPos();
                        }
                        player.node.setAttribute('x', player.dpos.x);
                        break;
                    }
                    case 'ArrowDown': {
                        player.dpos.y += shift;
                        if (player.dpos.y >= field[player.pos.y][player.pos.x].tlcp.y) {
                            player.dpos.y = field[player.pos.y][player.pos.x].tlcp.y;
                            player.isMoving = false;
                            player.CheckPos();
                        }
                        player.node.setAttribute('y', player.dpos.y);
                        break;
                    }
                    case 'ArrowLeft': {
                        player.dpos.x -= shift;
                        if (player.dpos.x <= field[player.pos.y][player.pos.x].tlcp.x) {
                            player.dpos.x = field[player.pos.y][player.pos.x].tlcp.x;
                            player.isMoving = false;
                            player.CheckPos();
                        }
                        player.node.setAttribute('x', player.dpos.x);
                        break;
                    }
                }
            }
            pts = ts;
            window.requestAnimationFrame(render);
        });
    </script>
</body>
</html>