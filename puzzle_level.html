<!DOCTYPE html>
<html>
<head>
    <title>puzzle_level</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        html {
            user-select: none;
            overflow: hidden;
        }

        body {
            margin: 0;
            padding: 0;
            background-color: #323232;
            display: table-cell;
            height: 100vh;
            width: 100vw;
            vertical-align: middle;
        }

        .menuWrap {
            width: 100vmin;
            height: 100vh;
            margin: 0 auto;
            background-color: rgba(245, 245, 245, 0.05);
        }

            .menuWrap > .tlControls {
                display: flex;
                flex-direction: row;
                position: absolute;
                top: 1rem;
                left: 1rem;
                font-family: monospace;
                font-size: 1.5rem;
                color: whitesmoke;
            }

                .menuWrap > .tlControls > div {
                    padding: 1rem;
                    cursor: pointer;
                }

                    .menuWrap > .tlControls > div:hover {
                        background-color: rgba(245, 245, 245, 0.1);
                    }

        .levelWrap {
            width: 80vmin;
            height: calc(80vmin / 16 * 9);
            margin: 0 auto;
        }

            .levelWrap > .backBtn {
                position: absolute;
                top: 1rem;
                left: 1rem;
                padding: 1rem;
                font-family: monospace;
                font-size: 1.5rem;
                color: whitesmoke;
                cursor: pointer;
            }

                .levelWrap > .backBtn:hover {
                    background-color: rgba(245, 245, 245, 0.1);
                }

            .levelWrap > .orig {
                width: 80vmin;
                height: auto;
                position: absolute;
                display: none;
            }

            .levelWrap > .field {
                border-collapse: collapse;
            }

                .levelWrap > .field td {
                    padding: 0;
                }
    </style>
</head>
<body>
    <script>
        class Scene {
            constructor(name, params) {
                return new this.CreateScene[name](params);
            };
            CreateScene = {
                menu: function () {
                    // create wrap
                    let wrap = document.createElement('div');
                    wrap.className = 'menuWrap';
                    document.body.appendChild(wrap);
                    // create top-left controls
                    let tlControls = document.createElement('div');
                    tlControls.className = 'tlControls';
                    wrap.appendChild(tlControls);
                    // create exit button
                    let exitBtn = document.createElement('div');
                    exitBtn.className = 'exitBtn';
                    exitBtn.innerHTML = 'exit';
                    exitBtn.onclick = function () {
                        alert('exit');
                    };
                    tlControls.appendChild(exitBtn);
                    // create options button
                    let optionsBtn = document.createElement('div');
                    optionsBtn.className = 'optionsBtn';
                    optionsBtn.innerHTML = 'options';
                    optionsBtn.onclick = function () {
                        alert('options');
                    };
                    tlControls.appendChild(optionsBtn);
                },
                options: function () { },
                level: function (num) {
                    let rows = 4;
                    let cols = 4;
                    let cells = [];
                    let tiles = [];
                    // create wrap
                    let wrap = document.createElement('div');
                    wrap.className = 'levelWrap';
                    document.body.appendChild(wrap);
                    // create back button
                    let backBtn = document.createElement('div');
                    backBtn.className = 'backBtn';
                    backBtn.innerHTML = 'back';
                    backBtn.onclick = function () {
                        App.scene.Destroy();
                        App.scene = new Scene('menu');
                    };
                    wrap.appendChild(backBtn);
                    // load original image
                    let orig = new Image();
                    orig.className = 'orig';
                    //orig.crossOrigin = 'Anonymous';
                    orig.onload = function () {
                        wrap.appendChild(orig);
                        // create field
                        let field = document.createElement('table');
                        field.className = 'field';
                        let tbody = document.createElement('tbody');
                        for (let r = 0; r < rows; r++) {
                            let row = document.createElement('tr');
                            for (let c = 0; c < cols; c++) {
                                let cell = document.createElement('td');
                                cell.setAttribute('row', r);
                                cell.setAttribute('col', c);
                                row.appendChild(cell);
                                cells.push(cell);
                            }
                            tbody.appendChild(row);
                        }
                        field.appendChild(tbody);
                        wrap.appendChild(field);
                        // create tiles
                        for (let r = 0; r < rows; r++) {
                            for (let c = 0; c < cols; c++) {
                                let tile = document.createElement('div');
                                tile.className = 'tile';
                                tile.style.width = `calc(80vmin / ${cols})`;
                                tile.style.height = `calc(80vmin / 16 * 9 / ${rows})`;
                                tile.style.backgroundImage = 'url("https://i3.ytimg.com/vi/MG_yFJt3PsM/maxresdefault.jpg")';
                                tile.style.backgroundRepeat = 'no-repeat';
                                tile.style.backgroundPositionX = `calc(0px - (80vmin / ${cols} * ${c}))`;
                                tile.style.backgroundPositionY = `calc(0px - (80vmin / 16 * 9 / ${rows} * ${r}))`;
                                tile.style.backgroundSize = `80vmin calc(80vmin / 16 * 9)`;
                                tile.setAttribute('target-row', r);
                                tile.setAttribute('target-col', c);
                                tile.onmousedown = function (e) {
                                    e.target.setDragStyles(e.x, e.y);
                                    App.drag.enabled = true;
                                    App.drag.element = e.target;
                                };
                                tile.setDragStyles = function (x, y) {
                                    this.style.position = 'absolute';
                                    this.style.left = `calc(${x + 'px'} - 80vmin / ${App.scene.cols} / 2)`;
                                    this.style.top = `calc(${y + 'px'} - 80vmin / 16 * 9 / ${App.scene.rows} / 2)`;
                                    this.style.boxShadow = '0 0 0.5vmin whitesmoke';
                                };
                                tile.setDefaultStyles = function () {
                                    this.style.position = 'static';
                                    this.style.left = 'auto';
                                    this.style.top = 'auto';
                                    this.style.boxShadow = 'none';
                                };
                                tiles.push(tile);
                            }
                        }
                        // generate random array
                        let arr = new Array();
                        for (let i = 0; i < (rows * cols); i++) {
                            arr.push(i);
                        }
                        // append tiles
                        cells.forEach(function (cell) {
                            let tdx = Math.floor(Math.random() * arr.length);
                            cell.appendChild(tiles[arr[tdx]]);
                            arr.splice(tdx, 1);
                        });
                    };
                    orig.src = 'https://i3.ytimg.com/vi/MG_yFJt3PsM/maxresdefault.jpg';
                    // set vars
                    this.rows = rows;
                    this.cols = cols;
                    this.cells = cells;
                    this.tiles = tiles;
                    // set methods
                    this.Destroy = function () {
                        document.querySelector('.levelWrap').remove();
                    };
                }
            };
            CheckTiles = function () {
                App.scene.tiles.forEach(function (tile) {
                });
            };
        };
        /**
         * @namespace
         * @property {Scene} scene - current scene container
         */
        let App = {
            scene: new Scene('level'),
            drag: {
                enabled: false,
                element: null
            }
        };
        /**
         * passive mousemove listener
         * works only in drag state
         */
        window.addEventListener('mousemove', function (e) {
            if (App.drag.enabled) {
                App.drag.element.style.left = `calc(${e.x + 'px'} - 80vmin / ${App.scene.cols} / 2)`;
                App.drag.element.style.top = `calc(${e.y + 'px'} - 80vmin / 16 * 9 / ${App.scene.rows} / 2)`;
            }
        }, false);
        /**
         * passive mousemove listener to drag tiles
         * works only in drag state
         */
        window.addEventListener('mouseup', function (e) {
            if (App.drag.enabled) {
                App.drag.enabled = false;
                let tilesAtPoint = document.elementsFromPoint(e.x, e.y).filter(el => el.className == 'tile');
                if (tilesAtPoint.length == 2) {
                    // swap tiles
                    let cellAtPoint = document.elementsFromPoint(e.x, e.y).find(el => el.tagName == 'TD');
                    App.drag.element.parentNode.appendChild(tilesAtPoint.pop());
                    cellAtPoint.appendChild(App.drag.element);
                }
                // set default styles of drag tile
                App.drag.element.setDefaultStyles();
                // remove App.drag.element
                App.drag.element = null;
            }
        }, false);
    </script>
</body>
</html>