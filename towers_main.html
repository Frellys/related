<!DOCTYPE html>
<html lang="en-us">
<head>
    <title>towers_main</title>
    <meta charset="UTF-8">
    <meta name="description" content="TOWERS UI">
    <meta name="author" content="SAARSE">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        html {
            user-select: none;
            overflow: hidden;
        }

        body {
            margin: 0;
            padding: 0;
            background-color: whitesmoke;
            display: table-cell;
            height: 100vh;
            width: 100vw;
            vertical-align: middle;
        }

        header {
            display: flex;
            flex-direction: row;
            position: absolute;
            top: 0;
            width: 100vw;
            height: auto;
            font-family: monospace;
            font-size: 1.5rem;
            color: #323232;
        }

            header > div {
                flex: 1;
                padding: 0.5ch 2ch;
                background-color: transparent;
                transition: all 0.3s;
            }

                header > div:hover {
                    background-color: rgba(50, 50, 50, 0.25);
                }

            header > .bank {
                text-align: center;
            }

            header > .time {
                text-align: end;
            }

        .mousePos {
            position: absolute;
            bottom: 1rem;
            left: 1rem;
            font-family: monospace;
            font-size: 0.75rem;
            color: rgba(50, 50, 50, 0.5);
        }

        svg {
            pointer-events: none;
        }

            svg g {
                cursor: pointer;
                pointer-events: all;
            }

                svg g .outline {
                    fill: transparent;
                    transition: all 0.3s;
                }

                svg g:hover .outline {
                    fill: rgba(50, 50, 50, 0.1);
                }

        .enemy {
            fill: red;
        }

        /*.enemy {
            fill: red;
            animation: move 4s linear;
        }

        @keyframes move {
            0% {
                x: 50;
                y: 50;
            }

            25% {
                x: 160;
                y: 50;
            }

            50% {
                x: 160;
                y: 160;
            }

            75% {
                x: 160;
                y: 270;
            }

            100% {
                x: 270;
                y: 270;
            }
        }*/
    </style>
</head>
<body>
    <script>
        window.onload = function () {
            this.App = new function () {
                this.xmlns = 'http://www.w3.org/2000/svg';
                this.width = screen.width;
                this.height = screen.height;
                this.vmin = Math.floor(Math.min(this.width, this.height) / 100);
                this.field = [
                    [
                        { type: 'road', rid: 0 },
                        { type: 'road', rid: 1 },
                        { type: 'empty' },
                        { type: 'add' }
                    ],
                    [
                        { type: 'empty' },
                        { type: 'road', rid: 2 },
                        { type: 'empty' }
                    ],
                    [
                        { type: 'empty' },
                        { type: 'road', rid: 3 },
                        { type: 'road', rid: 4 }
                    ]
                ];
                this.road = {
                    length: 0,
                    path: {}
                };
                this.enemySize = (2 * this.vmin);
                this.tileSize = (10 * this.vmin);
                this.mouse = {
                    pad: Math.max(this.width, this.height).toString().length,
                    pos: {
                        x: 0,
                        y: 0
                    }
                };
            };
            this.UI = new function () {
                this.header = new Header();
                this.field = new Field();
                this.enemy = new Enemy();
                this.field.appendChild(this.enemy);
                this.mouse = new MousePos();
                this.lastFrame = new Date().getTime();
                this.render = window.requestAnimationFrame(Render);
            };
        };
        function Field() {
            let el = document.createElementNS(App.xmlns, 'svg');
            el.tiles = [];
            el.style.display = 'block';
            el.style.margin = '0 auto';
            el.setAttribute('width', App.field[0].length * (App.tileSize + App.vmin) + App.vmin + 'px');
            el.setAttribute('height', App.field.length * (App.tileSize + App.vmin) + App.vmin + 'px');
            el.setAttribute('viewbox', `0 0 ${App.field[0].length * (App.tileSize + App.vmin) + App.vmin} ${App.field.length * (App.tileSize + App.vmin) + App.vmin}`);
            el.setAttribute('shape-rendering', 'optimizespeed');
            el.setAttribute('perserveAspectRatio', 'none');
            App.field.forEach(function (row, rdx) {
                row.forEach(function (col, cdx) {
                    let tile = new Tile(col, rdx, cdx);
                    el.tiles.push(tile);
                    el.appendChild(tile);
                    if (col.type == 'road') {
                        App.road.length++;
                        App.road.path[col.rid] = {
                            x: tile.data.x + (App.tileSize / 2),
                            y: tile.data.y + (App.tileSize / 2)
                        };
                    }
                });
            });
            let road = new Road();
            el.road = road;
            el.appendChild(road);
            let fin = new Fin(el);
            el.fin = fin;
            document.body.appendChild(el);
            return el;
        };
        function Tile(cnt, row, col) {
            let el = document.createElementNS(App.xmlns, 'g');
            el.data = {
                cnt: cnt,
                row: row,
                col: col,
                x: col * (App.tileSize + App.vmin) + App.vmin,
                y: row * (App.tileSize + App.vmin) + App.vmin
            };
            {
                /**
                 * outline
                 */
                let rect = document.createElementNS(App.xmlns, 'rect');
                rect.setAttribute('class', 'outline');
                rect.setAttribute('x', el.data.x);
                rect.setAttribute('y', el.data.y);
                rect.setAttribute('width', App.tileSize);
                rect.setAttribute('height', App.tileSize);
                rect.style.stroke = '#323232';
                rect.style.strokeWidth = '1';
                el.appendChild(rect);
            }
            {
                /**
                 * rc-text
                 */
                let text = document.createElementNS(App.xmlns, 'text');
                text.innerHTML = 'r' + row + 'c' + col;
                text.setAttribute('x', el.data.x + App.vmin / 2);
                text.setAttribute('y', el.data.y + App.vmin / 2);
                text.setAttribute('dominant-baseline', 'hanging');
                text.style.fontFamily = 'monospace';
                text.style.fontSize = App.vmin + 'px';
                text.style.fill = '#323232';
                el.appendChild(text);
            }
            if (cnt.type == 'add') {
                let plus = document.createElementNS(App.xmlns, 'path');
                plus.setAttribute('d', `M ${el.data.x + 30}, ${el.data.y + 50} L ${el.data.x + App.tileSize - 30}, ${el.data.y + 50} M ${el.data.x + 50}, ${el.data.y + 30} L ${el.data.x + 50}, ${el.data.y + App.tileSize - 30}`);
                plus.style.fill = 'transparent';
                plus.style.stroke = '#323232';
                plus.style.strokeWidth = App.vmin / 2;
                el.appendChild(plus);
            }
            el.onclick = function () {
                console.log(this.data);
            };
            return el;
        };
        function Road() {
            let el = document.createElementNS(App.xmlns, 'path');
            let d = [];
            for (let i = 0; i < Object.keys(App.road.path).length; i++) {
                d.push((i ? 'L' : 'M') + ' ' + App.road.path[i].x + ', ' + App.road.path[i].y);
            }
            el.setAttribute('d', d.join(' '));
            el.setAttribute('pointer-events', 'none');
            el.style.fill = 'transparent';
            el.style.stroke = '#323232';
            el.style.strokeWidth = App.vmin / 2;
            return el;
        };
        function Enemy() {
            let el = document.createElementNS(App.xmlns, 'rect');
            el.pos = {
                x: App.road.path[0].x,
                y: App.road.path[0].y
            };
            el.speed = 10 * 1000;
            el.track = [];
            for (let i = 0; i < App.road.length; i++) {
                el.track.push({
                    x: App.road.path[i].x,
                    y: App.road.path[i].y
                });
            }
            el.setAttribute('class', 'enemy');
            el.setAttribute('x', el.pos.x - App.enemySize / 2);
            el.setAttribute('y', el.pos.y - App.enemySize / 2);
            el.setAttribute('width', App.vmin * 2);
            el.setAttribute('height', App.vmin * 2);
            //el.addEventListener('animationend', function () {
            //    console.log('lost');
            //}, false);
            return el;
        };
        function Header() {
            let el = document.createElement('header');
            {
                let esc = new Esc();
                el.esc = esc;
                el.appendChild(esc);
                function Esc() {
                    let el = document.createElement('div');
                    el.className = 'esc';
                    el.innerHTML = 'esc';
                    return el;
                };
            }
            {
                let controls = new Controls();
                el.controls = controls;
                el.appendChild(controls);
                function Controls() {
                    let el = document.createElement('div');
                    return el;
                };
            }
            {
                let bank = new Bank();
                el.bank = bank;
                el.appendChild(bank);
                function Bank() {
                    let el = document.createElement('div');
                    el.className = 'bank';
                    el.innerHTML = '0.000000000';
                    return el;
                };
            }
            {
                let time = new Time();
                el.time = time;
                el.appendChild(time);
                window.setInterval(function () {
                    let dt = new Date();
                    UI.header.time.innerHTML = `${dt.getHours().toString().padStart(2, '0')}:${dt.getMinutes().toString().padStart(2, '0')}`;
                }, 1000);
                function Time() {
                    let el = document.createElement('div');
                    el.className = 'time';
                    el.innerHTML = 'xx:xx';
                    return el;
                };
            }
            document.body.appendChild(el);
            return el;
        };
        function MousePos() {
            let el = document.createElement('div');
            el.className = 'mousePos';
            let x = document.createElement('div');
            x.className = 'x';
            x.innerHTML = ('').padStart(App.mouse.pad, '0');
            el.appendChild(x);
            let y = document.createElement('div');
            y.className = 'y';
            y.innerHTML = ('').padStart(App.mouse.pad, '0')
            el.appendChild(y);
            el.pos = {
                x: x,
                y: y
            };
            window.addEventListener('mousemove', function (e) {
                App.mouse.pos.x = e.x;
                App.mouse.pos.y = e.y;
                UI.mouse.pos.x.innerHTML = e.x.toString().padStart(App.mouse.pad, '0');
                UI.mouse.pos.y.innerHTML = e.y.toString().padStart(App.mouse.pad, '0');
            }, false);
            document.body.appendChild(el);
            return el;
        };
        function Fin(field) {
            let fTile = field.tiles.find(t => t.data.cnt.type == 'road' && t.data.cnt.rid == (App.road.length - 1));
            let outer = document.createElementNS(App.xmlns, 'rect');
            outer.setAttribute('x', fTile.data.x + App.tileSize / 2 - App.vmin * 2);
            outer.setAttribute('y', fTile.data.y + App.tileSize / 2 - App.vmin * 2);
            outer.setAttribute('width', App.vmin * 4);
            outer.setAttribute('height', App.vmin * 4);
            outer.style.fill = 'cyan';
            outer.style.stroke = '#323232';
            outer.style.strokeWidth = App.vmin / 4;
            fTile.appendChild(outer);
            let inner = document.createElementNS(App.xmlns, 'rect');
            inner.setAttribute('x', fTile.data.x + App.tileSize / 2 - App.vmin);
            inner.setAttribute('y', fTile.data.y + App.tileSize / 2 - App.vmin);
            inner.setAttribute('width', App.vmin * 2);
            inner.setAttribute('height', App.vmin * 2);
            inner.style.fill = '#323232';
            fTile.appendChild(inner);
            return fTile;
        };
        function Render() {
            let ts = new Date().getTime();
            let delta = ts - UI.lastFrame;
            //let dst = UI.enemy.speed / (delta * 1000);
            //UI.enemy.pos.x += dst;
            //UI.enemy.setAttribute('x', UI.enemy.pos.x - App.enemySize / 2);
            UI.lastFrame = ts;
            UI.render = window.requestAnimationFrame(Render);
        };
    </script>
</body>
</html>